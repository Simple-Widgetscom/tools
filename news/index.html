<!DOCTYPE html>
<html lang="en" class="">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>News</title>
  <link href="../assets/output.css" rel="stylesheet">
  <script src="../assets/theme.js"></script>
</head>

<body class="m-0 font-sans p-8 leading-relaxed transition-colors duration-500
             bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-50">
  <div class="max-w-3xl mx-auto">
    <h1 class="text-[4vw] font-light text-center mb-8 tracking-wider
               max-md:text-[8vw]">Latest News</h1>

    <div class="text-center mb-8 flex gap-4 justify-center flex-wrap max-md:flex-col max-md:items-center">
      <button class="category-btn active px-4 py-2 text-base rounded-lg cursor-pointer transition-all
                     bg-gray-800 text-white dark:bg-gray-100 dark:text-gray-900
                     hover:opacity-80 max-md:w-48" data-category="general">General</button>
      <button class="category-btn px-4 py-2 text-base rounded-lg cursor-pointer transition-all
                     bg-gray-800 text-white dark:bg-gray-100 dark:text-gray-900
                     hover:opacity-80 max-md:w-48" data-category="technology">Technology</button>
      <button class="category-btn px-4 py-2 text-base rounded-lg cursor-pointer transition-all
                     bg-gray-800 text-white dark:bg-gray-100 dark:text-gray-900
                     hover:opacity-80 max-md:w-48" data-category="business">Business</button>
      <button class="category-btn px-4 py-2 text-base rounded-lg cursor-pointer transition-all
                     bg-gray-800 text-white dark:bg-gray-100 dark:text-gray-900
                     hover:opacity-80 max-md:w-48" data-category="health">Health</button>
      <button class="category-btn px-4 py-2 text-base rounded-lg cursor-pointer transition-all
                     bg-gray-800 text-white dark:bg-gray-100 dark:text-gray-900
                     hover:opacity-80 max-md:w-48" data-category="science">Science</button>
      <button id="refresh-btn" class="px-4 py-2 text-base rounded-lg cursor-pointer transition-all
                     bg-transparent border border-gray-800 dark:border-gray-200
                     hover:bg-gray-800 hover:text-white dark:hover:bg-gray-200 dark:hover:text-gray-900
                     max-md:w-48">Refresh</button>
    </div>

    <div id="news-container">
      <div class="text-center text-2xl opacity-60 my-8">Loading news...</div>
    </div>
  </div>

  <style>
    .category-btn.active {
      opacity: 1;
      box-shadow: 0 0 0 2px currentColor;
    }
  </style>

  <script>
    class NewsApp {
      constructor() {
        this.currentCategory = 'general';
        this.newsContainer = document.getElementById('news-container');
        this.categoryButtons = document.querySelectorAll('.category-btn');
        this.refreshButton = document.getElementById('refresh-btn');

        this.initEventListeners();
        this.loadNews();
      }

      initEventListeners() {
        this.categoryButtons.forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.setActiveCategory(e.target.dataset.category);
          });
        });

        this.refreshButton.addEventListener('click', () => {
          this.loadNews();
        });
      }

      setActiveCategory(category) {
        this.currentCategory = category;

        this.categoryButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.category === category);
        });

        this.loadNews();
      }

      async loadNews() {
        this.showLoading();

        try {
          const rssFeeds = {
            general: 'https://feeds.bbci.co.uk/news/rss.xml',
            technology: 'https://feeds.bbci.co.uk/news/technology/rss.xml',
            business: 'https://feeds.bbci.co.uk/news/business/rss.xml',
            health: 'https://feeds.bbci.co.uk/news/health/rss.xml',
            science: 'https://feeds.bbci.co.uk/news/science_and_environment/rss.xml'
          };

          const rssUrl = rssFeeds[this.currentCategory];
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}`;

          const response = await fetch(proxyUrl);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const xmlText = data.contents;

          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

          const items = xmlDoc.querySelectorAll('item');
          const articles = Array.from(items).slice(0, 15).map(item => {
            return {
              title: item.querySelector('title')?.textContent || 'No title',
              link: item.querySelector('link')?.textContent || '#',
              description: item.querySelector('description')?.textContent || '',
              pubDate: item.querySelector('pubDate')?.textContent || new Date().toISOString(),
              author: item.querySelector('author')?.textContent || 'BBC News'
            };
          });

          this.renderNews(articles);
        } catch (error) {
          console.error('Error fetching news:', error);
          this.showError('Failed to load news. Please try again later.');
        }
      }

      showLoading() {
        this.newsContainer.textContent = '';
        const div = document.createElement('div');
        div.className = 'text-center text-2xl opacity-60 my-8';
        div.textContent = 'Loading news...';
        this.newsContainer.appendChild(div);
      }

      showError(message) {
        this.newsContainer.textContent = '';
        const div = document.createElement('div');
        div.className = 'text-center text-xl text-red-600 dark:text-red-400 my-8';
        div.textContent = message;
        this.newsContainer.appendChild(div);
      }

      renderNews(articles) {
        if (!articles || articles.length === 0) {
          this.showError('No news available.');
          return;
        }

        this.newsContainer.textContent = '';

        articles.forEach(article => {
          const publishedDate = new Date(article.pubDate).toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          let description = article.description || '';
          description = description.replace(/<[^>]*>/g, '');
          description = description.length > 200 ? description.substring(0, 200) + '...' : description;

          const articleEl = document.createElement('article');
          articleEl.className = 'py-6 border-b border-gray-200 dark:border-gray-700 last:border-b-0 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800 -mx-4 px-4 rounded';

          const titleEl = document.createElement('h2');
          titleEl.className = 'text-xl font-medium mb-2';

          const linkEl = document.createElement('a');
          linkEl.href = article.link;
          linkEl.target = '_blank';
          linkEl.rel = 'noopener noreferrer';
          linkEl.className = 'text-inherit no-underline hover:text-blue-600 dark:hover:text-blue-400';
          linkEl.textContent = article.title;
          titleEl.appendChild(linkEl);

          const metaEl = document.createElement('div');
          metaEl.className = 'text-sm opacity-60 mb-2';
          metaEl.textContent = `${publishedDate}${article.author ? ` â€¢ ${article.author}` : ''}`;

          articleEl.appendChild(titleEl);
          articleEl.appendChild(metaEl);

          if (description) {
            const descEl = document.createElement('p');
            descEl.className = 'text-base opacity-80';
            descEl.textContent = description;
            articleEl.appendChild(descEl);
          }

          this.newsContainer.appendChild(articleEl);
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new NewsApp();
    });
  </script>
</body>

</html>
